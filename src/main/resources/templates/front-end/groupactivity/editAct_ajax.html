<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>編輯活動 | 島遊kha</title>
    <th:block th:replace="~{/navTemplate :: headResources}"></th:block>
    <link rel="stylesheet" th:href="@{/css/light.css}" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <!-- GroupActivity 模組 CSS -->
    <link
      rel="stylesheet"
      th:href="@{/css/groupactivity/styleAct_common.css}"
    />
    <link rel="stylesheet" th:href="@{/css/groupactivity/styleAct_front.css}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="light">
    <div class="app-container">
      <div th:insert="~{/navTemplate :: navbar}"></div>

      <div class="main-content act-page">
        <div th:insert="~{/subnavActFront :: subnav('edit')}"></div>

        <main class="content-area-main act-area">
          <div class="act-detail-container">
            <form
              id="editActForm"
              method="post"
              enctype="multipart/form-data"
              novalidate
            >
              <input type="hidden" name="actId" th:value="${actVo.actId}" />

              <div class="act-detail-info">
                <div class="form-floating">
                  <input
                    type="text"
                    name="actName"
                    id="actName"
                    class="form-control"
                    placeholder="請輸入活動名稱"
                    th:value="${actVo.actName}"
                    required
                  />
                  <label for="actName"
                    >活動名稱 <span class="required-mark">*</span></label
                  >
                  <div class="invalid-feedback"></div>
                </div>
                <div class="form-floating">
                  <input
                    type="number"
                    name="itnId"
                    id="itnId"
                    class="form-control"
                    placeholder="請輸入行程編號"
                    th:value="${actVo.itnId}"
                    required
                  />
                  <label for="itnId"
                    >行程編號 <span class="required-mark">*</span></label
                  >
                  <div class="invalid-feedback"></div>
                </div>
              </div>

              <div class="form-floating">
                <textarea
                  name="actDesc"
                  id="actDesc"
                  class="form-control large-textarea"
                  placeholder="請輸入活動說明"
                  th:text="${actVo.actDesc}"
                ></textarea>
                <label for="actDesc">活動說明</label>
              </div>

              <br />

              <div class="act-detail-info">
                <div class="form-floating">
                  <input
                    type="datetime-local"
                    name="actStart"
                    id="actStart"
                    class="form-control"
                    th:value="${#temporals.format(actVo.actStart,'yyyy-MM-dd''T''HH:mm')}"
                    required
                  />
                  <label for="actStart"
                    >活動開始時間 <span class="required-mark">*</span></label
                  >
                  <div class="invalid-feedback"></div>
                </div>
                <div class="form-floating">
                  <input
                    type="datetime-local"
                    name="actEnd"
                    id="actEnd"
                    class="form-control"
                    th:value="${#temporals.format(actVo.actEnd,'yyyy-MM-dd''T''HH:mm')}"
                    required
                  />
                  <label for="actEnd"
                    >活動結束時間 <span class="required-mark">*</span></label
                  >
                  <div class="invalid-feedback"></div>
                </div>
              </div>

              <!-- 活動類型和地區 -->
              <div class="act-detail-info" style="display: block">
                <!-- 活動類型標籤選擇 -->
                <div class="tag-section">
                  <label class="tag-label"
                    >活動類型 <span class="required-mark">*</span></label
                  >
                  <div class="tag-container" id="actTypeContainer">
                    <button
                      type="button"
                      class="tag-button"
                      data-value="ARTS"
                      th:classappend="${actVo.actType != null and #strings.contains(actVo.actType, 'ARTS')} ? 'selected' : ''"
                    >
                      藝文
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="ECOLOGY"
                      th:classappend="${actVo.actType != null and #strings.contains(actVo.actType, 'ECOLOGY')} ? 'selected' : ''"
                    >
                      生態
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="OUTDOOR"
                      th:classappend="${actVo.actType != null and #strings.contains(actVo.actType, 'OUTDOOR')} ? 'selected' : ''"
                    >
                      戶外
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="SPORTS"
                      th:classappend="${actVo.actType != null and #strings.contains(actVo.actType, 'SPORTS')} ? 'selected' : ''"
                    >
                      運動
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="FOOD"
                      th:classappend="${actVo.actType != null and #strings.contains(actVo.actType, 'FOOD')} ? 'selected' : ''"
                    >
                      美食
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="FAMILY"
                      th:classappend="${actVo.actType != null and #strings.contains(actVo.actType, 'FAMILY')} ? 'selected' : ''"
                    >
                      親子
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="SENIOR"
                      th:classappend="${actVo.actType != null and #strings.contains(actVo.actType, 'SENIOR')} ? 'selected' : ''"
                    >
                      銀髮
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="PET"
                      th:classappend="${actVo.actType != null and #strings.contains(actVo.actType, 'PET')} ? 'selected' : ''"
                    >
                      寵物
                    </button>
                  </div>
                  <input
                    type="hidden"
                    name="actType"
                    id="actTypeInput"
                    th:value="${actVo.actType}"
                  />
                </div>

                <!-- 活動地區標籤選擇 -->
                <div class="tag-section">
                  <label class="tag-label"
                    >活動地區 <span class="required-mark">*</span></label
                  >
                  <div class="tag-container" id="actCityContainer">
                    <button
                      type="button"
                      class="tag-button"
                      data-value="TAIPEI"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'TAIPEI')} ? 'selected' : ''"
                    >
                      台北
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="NEW_TAIPEI"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'NEW_TAIPEI')} ? 'selected' : ''"
                    >
                      新北
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="TAOYUAN"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'TAOYUAN')} ? 'selected' : ''"
                    >
                      桃園
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="TAICHUNG"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'TAICHUNG')} ? 'selected' : ''"
                    >
                      台中
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="TAINAN"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'TAINAN')} ? 'selected' : ''"
                    >
                      台南
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="KAOHSIUNG"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'KAOHSIUNG')} ? 'selected' : ''"
                    >
                      高雄
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="KEELUNG"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'KEELUNG')} ? 'selected' : ''"
                    >
                      基隆
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="HSINCHU"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'HSINCHU')} ? 'selected' : ''"
                    >
                      新竹
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="MIAOLI"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'MIAOLI')} ? 'selected' : ''"
                    >
                      苗栗
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="CHANGHUA"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'CHANGHUA')} ? 'selected' : ''"
                    >
                      彰化
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="NANTOU"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'NANTOU')} ? 'selected' : ''"
                    >
                      南投
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="YUNLIN"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'YUNLIN')} ? 'selected' : ''"
                    >
                      雲林
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="CHIAYI"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'CHIAYI')} ? 'selected' : ''"
                    >
                      嘉義
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="PINGTUNG"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'PINGTUNG')} ? 'selected' : ''"
                    >
                      屏東
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="YILAN"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'YILAN')} ? 'selected' : ''"
                    >
                      宜蘭
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="HUALIEN"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'HUALIEN')} ? 'selected' : ''"
                    >
                      花蓮
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="TAITUNG"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'TAITUNG')} ? 'selected' : ''"
                    >
                      台東
                    </button>
                    <button
                      type="button"
                      class="tag-button"
                      data-value="ISLANDS"
                      th:classappend="${actVo.actCity != null and #strings.contains(actVo.actCity, 'ISLANDS')} ? 'selected' : ''"
                    >
                      離島
                    </button>
                  </div>
                  <input
                    type="hidden"
                    name="actCity"
                    id="actCityInput"
                    th:value="${actVo.actCity}"
                  />
                </div>
              </div>

              <!-- 圖片上傳 -->
              <div class="act-detail-info">
                <div>
                  <label class="act-detail-label">活動圖片</label>

                  <!-- 現有圖片顯示 -->
                  <div
                    class="current-image"
                    th:if="${actVo.actImg != null and actVo.actImg.length > 0}"
                    style="margin-bottom: 16px"
                  >
                    <label
                      style="
                        font-weight: bold;
                        color: #333;
                        display: block;
                        margin-bottom: 8px;
                      "
                      >目前圖片：</label
                    >
                    <img
                      th:src="@{'/api/act/image/' + ${actVo.actId}}"
                      alt="目前圖片"
                      style="
                        max-width: 200px;
                        max-height: 150px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        object-fit: cover;
                      "
                    />
                    <small style="color: #666; display: block; margin-top: 8px">
                      ※ 如果不上傳新圖片，將保留原有圖片
                    </small>
                  </div>

                  <div
                    th:if="${actVo.actImg == null or actVo.actImg.length == 0}"
                    style="
                      margin-bottom: 16px;
                      padding: 12px;
                      background-color: #f8f9fa;
                      border: 1px solid #dee2e6;
                      border-radius: 8px;
                      color: #666;
                    "
                  >
                    <strong>目前狀態：</strong> 使用預設圖片
                  </div>

                  <!-- 隱藏的檔案輸入框 -->
                  <input
                    type="file"
                    name="actImg"
                    id="actImgInput"
                    accept="image/*"
                    class="hidden"
                    title="選擇活動圖片"
                  />

                  <!-- 拖拽上傳區域 -->
                  <div id="dragDropArea" class="drag-drop-area">
                    <div class="drag-drop-content">
                      <div class="drag-drop-icon">
                        <svg
                          width="48"
                          height="48"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="1.5"
                        >
                          <rect
                            x="3"
                            y="3"
                            width="18"
                            height="18"
                            rx="2"
                            ry="2"
                          />
                          <circle cx="8.5" cy="8.5" r="1.5" />
                          <polyline points="21,15 16,10 5,21" />
                        </svg>
                      </div>
                      <div class="drag-drop-text">
                        <p class="drag-drop-main">拖曳圖片到這裡上傳</p>
                        <p class="drag-drop-sub">
                          或
                          <span class="drag-drop-browse">點擊瀏覽</span>
                          選擇檔案
                        </p>
                        <p class="drag-drop-hint">
                          支援 JPG、PNG、GIF 格式，檔案大小不超過 5MB
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- 圖片預覽區域 -->
                  <div id="imagePreview" class="image-preview-container hidden">
                    <div class="image-preview-wrapper">
                      <img
                        id="previewImg"
                        class="preview-image"
                        alt="活動圖片預覽"
                      />
                      <div class="image-overlay">
                        <button
                          type="button"
                          id="removeImage"
                          class="remove-image-btn"
                          title="移除圖片"
                        >
                          <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                          >
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                        </button>
                      </div>
                    </div>
                    <div id="compressionInfo" class="compression-info"></div>
                  </div>
                </div>
              </div>

              <hr />

              <!-- 報名時間設定 -->
              <div class="act-detail-info">
                <div class="form-floating">
                  <input
                    type="datetime-local"
                    name="signupStart"
                    id="signupStart"
                    class="form-control"
                    th:value="${#temporals.format(actVo.signupStart,'yyyy-MM-dd''T''HH:mm')}"
                    required
                  />
                  <label for="signupStart"
                    >報名開始時間 <span class="required-mark">*</span></label
                  >
                  <div class="invalid-feedback"></div>
                </div>
                <div class="form-floating">
                  <input
                    type="datetime-local"
                    name="signupEnd"
                    id="signupEnd"
                    class="form-control"
                    th:value="${#temporals.format(actVo.signupEnd,'yyyy-MM-dd''T''HH:mm')}"
                    required
                  />
                  <label for="signupEnd"
                    >報名截止時間 <span class="required-mark">*</span></label
                  >
                  <div class="invalid-feedback"></div>
                </div>
              </div>

              <!-- 人數和狀態設定 -->
              <div class="act-detail-info">
                <div class="form-floating">
                  <input
                    type="number"
                    name="maxCap"
                    id="maxCap"
                    class="form-control"
                    placeholder="請輸入人數需求"
                    th:value="${actVo.maxCap}"
                    min="1"
                    required
                  />
                  <label for="maxCap"
                    >人數需求 <span class="required-mark">*</span></label
                  >
                  <div class="invalid-feedback"></div>
                </div>
                <div class="form-floating">
                  <input
                    type="number"
                    name="signupCnt"
                    id="signupCnt"
                    class="form-control"
                    th:value="${actVo.signupCnt}"
                    readonly
                  />
                  <label for="signupCnt">已報名人數</label>
                </div>
              </div>

              <!-- 設定選項 -->
              <div class="act-detail-info">
                <div class="form-floating">
                  <select name="isPublic" id="isPublic" class="form-select">
                    <option value="0" th:selected="${actVo.isPublic == 0}">
                      私人
                    </option>
                    <option value="1" th:selected="${actVo.isPublic == 1}">
                      公開
                    </option>
                  </select>
                  <label for="isPublic">是否公開</label>
                </div>
                <div class="form-floating">
                  <select
                    name="allowCancel"
                    id="allowCancel"
                    class="form-select"
                  >
                    <option value="0" th:selected="${actVo.allowCancel == 0}">
                      不允許
                    </option>
                    <option value="1" th:selected="${actVo.allowCancel == 1}">
                      允許
                    </option>
                  </select>
                  <label for="allowCancel">是否允許退出</label>
                </div>
              </div>

              <!-- 招募狀態 -->
              <div class="form-floating">
                <select
                  name="recruitStatus"
                  id="recruitStatus"
                  class="form-select"
                >
                  <option value="0" th:selected="${actVo.recruitStatus == 0}">
                    招募中
                  </option>
                  <option value="1" th:selected="${actVo.recruitStatus == 1}">
                    成團
                  </option>
                  <option value="2" th:selected="${actVo.recruitStatus == 2}">
                    未成團
                  </option>
                  <option value="3" th:selected="${actVo.recruitStatus == 3}">
                    已取消
                  </option>
                  <option value="4" th:selected="${actVo.recruitStatus == 4}">
                    已凍結
                  </option>
                  <option value="5" th:selected="${actVo.recruitStatus == 5}">
                    已結束
                  </option>
                </select>
                <label for="recruitStatus">招募狀態</label>
              </div>

              <!-- 提交按鈕 -->
              <div class="act-detail-info">
                <button type="submit" class="act-btn act-btn-primary">
                  儲存修改
                </button>
              </div>
            </form>
          </div>
        </main>
      </div>
    </div>

    <!-- 標籤按鈕不需要額外的JavaScript庫 -->

    <!-- GroupActivity 模組 JavaScript -->
    <script th:src="@{/js/groupactivity/groupactivity-core.js}"></script>
    <script th:src="@{/js/groupactivity/groupactivity-form.js}"></script>
    <script th:src="@{/js/groupactivity/groupactivity-api.js}"></script>

    <script>
      function initializeForm() {
        const form = document.getElementById("editActForm");
        if (!form) return;

        // 初始化標籤按鈕選擇器
        initializeTagButtons();

        // 初始化拖拽上傳功能
        initializeDragDrop();

        // 初始化實時驗證
        initializeRealTimeValidation();

        // 表單提交事件
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          clearAllFieldErrors();
          handleEditFormSubmission(this);
        });
      }

      // 初始化標籤按鈕選擇器
      function initializeTagButtons() {
        // 處理活動類型標籤按鈕
        const actTypeContainer = document.getElementById("actTypeContainer");
        const actTypeInput = document.getElementById("actTypeInput");

        actTypeContainer.addEventListener("click", function (e) {
          if (e.target.classList.contains("tag-button")) {
            e.target.classList.toggle("selected");
            updateHiddenInput("actType");
          }
        });

        // 處理活動地區標籤按鈕
        const actCityContainer = document.getElementById("actCityContainer");
        const actCityInput = document.getElementById("actCityInput");

        actCityContainer.addEventListener("click", function (e) {
          if (e.target.classList.contains("tag-button")) {
            e.target.classList.toggle("selected");
            updateHiddenInput("actCity");
          }
        });
      }

      // 更新隱藏輸入框的值
      function updateHiddenInput(type) {
        const container = document.getElementById(type + "Container");
        const input = document.getElementById(type + "Input");
        const selectedButtons = container.querySelectorAll(
          ".tag-button.selected"
        );

        if (selectedButtons.length > 0) {
          // 只取第一個選中的值（與後端相容）
          input.value = selectedButtons[0].dataset.value;
        } else {
          input.value = "";
        }
      }

      // 初始化拖拽上傳功能
      function initializeDragDrop() {
        const dragDropArea = document.getElementById("dragDropArea");
        const fileInput = document.getElementById("actImgInput");
        const imagePreview = document.getElementById("imagePreview");
        const previewImg = document.getElementById("previewImg");
        const removeBtn = document.getElementById("removeImage");
        const compressionInfo = document.getElementById("compressionInfo");

        // 點擊拖拽區域開啟檔案選擇器
        dragDropArea.addEventListener("click", () => {
          fileInput.click();
        });

        // 檔案選擇事件
        fileInput.addEventListener("change", handleFileSelect);

        // 拖拽事件
        dragDropArea.addEventListener("dragover", handleDragOver);
        dragDropArea.addEventListener("dragenter", handleDragEnter);
        dragDropArea.addEventListener("dragleave", handleDragLeave);
        dragDropArea.addEventListener("drop", handleDrop);

        // 移除圖片按鈕
        removeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          removeImage();
        });

        function handleDragOver(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        function handleDragEnter(e) {
          e.preventDefault();
          e.stopPropagation();
          dragDropArea.classList.add("drag-over");
        }

        function handleDragLeave(e) {
          e.preventDefault();
          e.stopPropagation();
          if (!dragDropArea.contains(e.relatedTarget)) {
            dragDropArea.classList.remove("drag-over");
          }
        }

        function handleDrop(e) {
          e.preventDefault();
          e.stopPropagation();
          dragDropArea.classList.remove("drag-over");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith("image/")) {
              fileInput.files = files;
              handleFileSelect({ target: { files: [file] } });
            }
          }
        }

        function handleFileSelect(e) {
          const file = e.target.files[0];
          if (!file) return;

          if (!file.type.startsWith("image/")) {
            alert("請選擇圖片檔案");
            return;
          }

          // 直接顯示圖片預覽（簡化版本）
          showImagePreview(file);
        }

        function showImagePreview(file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            previewImg.src = e.target.result;
            dragDropArea.classList.add("hidden");
            imagePreview.classList.remove("hidden");

            // 顯示檔案資訊
            const fileSize = (file.size / 1024).toFixed(1);
            compressionInfo.innerHTML = `
              <div class="compression-stats">
                <span>檔案大小: ${fileSize} KB</span>
              </div>
            `;
          };
          reader.readAsDataURL(file);
        }

        function removeImage() {
          fileInput.value = "";
          previewImg.src = "";
          compressionInfo.innerHTML = "";
          dragDropArea.classList.remove("hidden");
          imagePreview.classList.add("hidden");
        }
      }

      // 初始化實時驗證
      function initializeRealTimeValidation() {
        // 設置實時驗證
        [
          "actName",
          "itnId",
          "actStart",
          "actEnd",
          "signupStart",
          "signupEnd",
          "maxCap",
        ].forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.addEventListener("blur", () => validateField(field));
            field.addEventListener("input", () => {
              if (field.classList.contains("is-invalid")) {
                validateField(field);
              }
            });
          }
        });
      }

      // 簡單的欄位驗證
      function validateField(field) {
        const value = field.value.trim();
        const isRequired = field.hasAttribute("required");

        if (isRequired && !value) {
          field.classList.add("is-invalid");
          const feedback = field.parentNode.querySelector(".invalid-feedback");
          if (feedback) {
            feedback.textContent = "此欄位為必填";
          }
          return false;
        } else {
          field.classList.remove("is-invalid");
          const feedback = field.parentNode.querySelector(".invalid-feedback");
          if (feedback) {
            feedback.textContent = "";
          }
          return true;
        }
      }

      // 清除所有欄位錯誤
      function clearAllFieldErrors() {
        // 1. 清除 is-invalid 樣式
        document.querySelectorAll(".is-invalid").forEach(function (field) {
          field.classList.remove("is-invalid");
        });
        // 2. 清空所有 .invalid-feedback 內容
        document
          .querySelectorAll(".invalid-feedback")
          .forEach(function (element) {
            element.textContent = "";
          });
      }

      // 處理編輯表單提交
      async function handleEditFormSubmission(form) {
        try {
          const formData = new FormData(form);

          // 標籤選擇的值已經通過隱藏輸入框自動包含在 FormData 中
          // 不需要額外處理，因為 updateHiddenInput 函數已經處理了值的設定

          // 顯示提交中的狀態
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = "儲存中...";
          submitBtn.disabled = true;

          // 使用直接的 fetch API，與新增表單邏輯一致
          const response = await fetch("/api/act/update", {
            method: "PUT",
            body: formData,
          });

          const result = await response.json();

          if (!response.ok) {
            // 處理錯誤回應
            let errorMessages = [];
            if (
              result.success === false &&
              result.errors &&
              Array.isArray(result.errors)
            ) {
              errorMessages = result.errors;
            } else if (result.success === false && result.error) {
              errorMessages = [result.error];
            } else if (result.message) {
              errorMessages = [result.message];
            } else if (result.error) {
              errorMessages = [result.error];
            } else {
              errorMessages = ["儲存失敗，請檢查輸入內容"];
            }

            // 顯示錯誤訊息並標記相應欄位
            // showErrorMessages(errorMessages); // 暫時註解統一錯誤訊息
            errorMessages.forEach((msg) => {
              const lowerMsg = msg.toLowerCase();
              if (msg.includes("活動名稱") || lowerMsg.includes("actname")) {
                markFieldAsInvalid("actName", msg);
              }
              if (msg.includes("行程編號") || lowerMsg.includes("itnid")) {
                markFieldAsInvalid("itnId", msg);
              }
              if (
                msg.includes("報名開始時間") ||
                lowerMsg.includes("signupstart")
              ) {
                markFieldAsInvalid("signupStart", msg);
              }
              if (
                msg.includes("報名截止時間") ||
                lowerMsg.includes("signupend")
              ) {
                markFieldAsInvalid("signupEnd", msg);
              }
              if (
                msg.includes("活動開始時間") ||
                lowerMsg.includes("actstart")
              ) {
                markFieldAsInvalid("actStart", msg);
              }
              if (msg.includes("活動結束時間") || lowerMsg.includes("actend")) {
                markFieldAsInvalid("actEnd", msg);
              }
              if (msg.includes("人數需求") || lowerMsg.includes("maxcap")) {
                markFieldAsInvalid("maxCap", msg);
              }
            });
          } else {
            // 成功情況
            showSuccessMessage("活動更新成功！正在跳轉...");
            // 跳轉到我的活動列表
            setTimeout(() => {
              if (result.data?.hostId || result.hostId) {
                window.location.href = `/act/member/listMy/${
                  result.data?.hostId || result.hostId
                }`;
              } else {
                window.history.back();
              }
            }, 1500);
          }
        } catch (error) {
          console.error("更新活動失敗:", error);
          // showErrorMessages("網路錯誤，請稍後再試"); // 暫時註解統一錯誤訊息
        } finally {
          // 恢復提交按鈕狀態
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.textContent = "儲存修改";
            submitBtn.disabled = false;
          }
        }
      }

      // 顯示錯誤訊息（與新增表單一致）
      function showErrorMessages(errors) {
        // 暫時註解統一錯誤訊息顯示功能
        /*
        clearAllFieldErrors();
        // 清除已存在的錯誤容器
        const existingErrorContainer = document.getElementById("errorMessages");
        if (existingErrorContainer) existingErrorContainer.remove();
        
        const errorContainer = document.createElement("div");
        errorContainer.id = "errorMessages";
        errorContainer.className = "alert alert-danger";
        errorContainer.style.margin = "16px 0";

        if (Array.isArray(errors)) {
          const errorList = document.createElement("ul");
          errorList.style.margin = "0";
          errorList.style.paddingLeft = "20px";
          errors.forEach((error) => {
            const listItem = document.createElement("li");
            listItem.textContent = error;
            errorList.appendChild(listItem);
          });
          errorContainer.appendChild(errorList);
        } else {
          errorContainer.textContent = errors;
        }

        const form = document.getElementById("editActForm");
        form.parentNode.insertBefore(errorContainer, form);
        errorContainer.scrollIntoView({ behavior: "smooth", block: "center" });
        */

        // 只清除欄位錯誤，不顯示頂部統一錯誤訊息
        clearAllFieldErrors();
      }

      // 標記欄位為無效
      function markFieldAsInvalid(fieldName, errorMessage = "") {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field) {
          field.classList.add("is-invalid");
          const feedbackElement =
            field.parentNode.querySelector(".invalid-feedback");
          if (feedbackElement && errorMessage) {
            feedbackElement.textContent = errorMessage;
          }
        }
      }

      // 顯示成功訊息
      function showSuccessMessage(message) {
        // 清除已存在的錯誤或成功訊息
        const errorContainer = document.getElementById("errorMessages");
        if (errorContainer) errorContainer.remove();

        const successDiv = document.createElement("div");
        successDiv.className = "alert alert-success";
        successDiv.textContent = message;
        successDiv.style.margin = "16px 0";

        const form = document.getElementById("editActForm");
        form.parentNode.insertBefore(successDiv, form);
        successDiv.scrollIntoView({ behavior: "smooth", block: "center" });

        setTimeout(() => {
          successDiv.remove();
        }, 3000);
      }

      // 頁面載入時初始化
      document.addEventListener("DOMContentLoaded", initializeForm);
    </script>
  </body>
</html>
