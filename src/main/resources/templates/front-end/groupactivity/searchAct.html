<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>搜尋活動 | 島遊kha</title>

    <!-- 模板與樣式 -->
    <th:block th:replace="~{/navTemplate :: headResources}"></th:block>
    <link rel="stylesheet" th:href="@{/css/light.css}" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <!-- GroupActivity 模組 CSS -->
    <link
      rel="stylesheet"
      th:href="@{/css/groupactivity/styleAct_common.css}"
    />
    <link rel="stylesheet" th:href="@{/css/groupactivity/styleAct_front.css}" />
  </head>
  <body class="light">
    <div class="app-container">
      <div th:insert="~{/navTemplate :: navbar}"></div>

      <div class="main-content act-page">
        <div th:insert="~{/subnavActFront :: subnav('search')}"></div>
        <div class="content-area-main act-area">
          <h1 class="act-front-title">搜尋活動</h1>
          <!-- 搜尋區域 -->
          <div class="act-search-container">
            <form id="searchForm" class="act-search-form">
              <div class="act-search-group">
                <label for="actNameInput" class="act-search-label"
                  >關鍵字搜尋</label
                >
                <input
                  type="text"
                  id="actNameInput"
                  name="actName"
                  class="act-search-input"
                  placeholder="輸入活動名稱關鍵字"
                />
              </div>

              <div class="act-search-group">
                <label for="maxCapInput" class="act-search-label"
                  >需求人數</label
                >
                <input
                  type="number"
                  id="maxCapInput"
                  name="maxCap"
                  class="act-search-input"
                  placeholder="輸入最低人數需求"
                  min="1"
                />
              </div>

              <div class="act-search-group">
                <label for="dateRangeStart" class="act-search-label"
                  >活動開始日期</label
                >
                <input
                  type="date"
                  id="dateRangeStart"
                  name="dateRangeStart"
                  class="act-search-input"
                  placeholder="選擇日期後的活動"
                />
              </div>

              <div class="act-search-actions">
                <button type="submit" class="act-btn act-btn-primary">
                  搜尋活動
                </button>
                <!--                <button-->
                <!--                  type="button"-->
                <!--                  onclick="loadAllActivities()"-->
                <!--                  class="act-btn act-btn-secondary"-->
                <!--                >-->
                <!--                  顯示全部-->
                <!--                </button>-->

                <!--                &lt;!&ndash; ======================================== &ndash;&gt;-->
                <!--                &lt;!&ndash; 測試相關按鈕 - 開發完成後可移除 &ndash;&gt;-->
                <!--                &lt;!&ndash; ======================================== &ndash;&gt;-->
                <!--                <button-->
                <!--                  type="button"-->
                <!--                  onclick="testApi()"-->
                <!--                  class="act-btn act-btn-secondary"-->
                <!--                  style="background-color: #ff9800"-->
                <!--                >-->
                <!--                  測試 API-->
                <!--                </button>-->
                <!--                <button-->
                <!--                  type="button"-->
                <!--                  onclick="testImageResponse()"-->
                <!--                  class="act-btn act-btn-secondary"-->
                <!--                  style="background-color: #ff9800"-->
                <!--                >-->
                <!--                  測試圖片回傳-->
                <!--                </button>-->
              </div>
            </form>
          </div>

          <!-- 搜尋結果 -->
          <div id="searchResults" style="display: none">載入中...</div>

          <!-- 初始狀態 -->
          <div
            id="initialState"
            style="
              text-align: center;
              padding: 40px;
              color: var(--md-sys-color-on-surface-variant);
            "
          >
            <h3>開始搜尋活動</h3>
            <p>使用上方的搜尋條件來找到您感興趣的活動</p>
          </div>
        </div>
      </div>
    </div>

    <!-- GroupActivity 模組 JavaScript -->
    <script th:src="@{/js/groupactivity/groupactivity-core.js}"></script>
    <script th:src="@{/js/groupactivity/groupactivity-ui.js}"></script>
    <script th:src="@{/js/groupactivity/groupactivity-api.js}"></script>

    <script>
      // 頁面變數
      const searchForm = document.getElementById("searchForm");
      const searchResults = document.getElementById("searchResults");
      const initialState = document.getElementById("initialState");
      let currentPage = 0;
      let isLastPage = false;

      // 使用共用函數
      const { formatDate, getStatusText } = GroupActivityCore;
      const { createActCard } = GroupActivityUI;
      const { buildSearchUrl, loadPaginatedResults } = GroupActivityAPI;

      // 活動卡片渲染器
      function renderActivityCard(activity) {
        return createActCard(activity, {
          showActions: true,
          showHostActions: false,
          showImage: true,
        });
      }

      // 搜尋活動
      async function searchActivities(isNewSearch = false) {
        try {
          const formData = new FormData(searchForm);
          const params = {
            actName: formData.get("actName")?.trim(),
            maxCap: formData.get("maxCap"),
            actStart: formData.get("dateRangeStart"),
          };

          // 隱藏初始狀態
          initialState.style.display = "none";
          searchResults.style.display = "block";

          const url = buildSearchUrl(params, isNewSearch ? 0 : currentPage + 1);
          const result = await loadPaginatedResults(
            url,
            searchResults,
            renderActivityCard,
            isNewSearch
          );

          if (isNewSearch) {
            currentPage = 0;
          } else {
            currentPage++;
          }

          isLastPage = !result.hasMore;

          // 添加載入更多按鈕
          if (result.hasMore) {
            const loadMoreBtn = document.createElement("button");
            loadMoreBtn.id = "loadMoreBtn";
            loadMoreBtn.className = "act-btn act-btn-primary";
            loadMoreBtn.textContent = "載入更多";
            loadMoreBtn.style.marginTop = "20px";
            loadMoreBtn.onclick = () => searchActivities(false);
            searchResults.appendChild(loadMoreBtn);
          }
        } catch (error) {
          console.error("搜尋失敗:", error);
        }
      }

      // 表單提交處理
      searchForm.addEventListener("submit", function (e) {
        e.preventDefault();
        searchActivities(true);
      });

      // 頁面載入時自動載入公開活動（最新優先）
      document.addEventListener("DOMContentLoaded", () => {
        // 自動載入公開活動（透過 hidden input 設定 isPublic=1）
        const formData = new FormData(searchForm);
        const searchUrl = buildSearchUrl(formData, 0);
        fetchActivities(searchUrl, true);

        // 隱藏初始狀態，因為我們要立即載入資料
        initialState.style.display = "none";
      });

      function loadAllActivities() {
        searchForm.reset();
        currentPage = 0;
        const formData = new FormData(searchForm);
        const searchUrl = buildSearchUrl(formData, currentPage);
        fetchActivities(searchUrl, true);
      }
    </script>
  </body>
</html>
