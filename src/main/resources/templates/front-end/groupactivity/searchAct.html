<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>搜尋活動 | 島遊kha</title>

    <!-- 模板與樣式 -->
    <th:block th:replace="~{/navTemplate :: headResources}"></th:block>
    <link rel="stylesheet" th:href="@{/css/light.css}" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/styleAct_front_enhanced.css}" />
  </head>
  <body class="light">
    <div class="app-container">
      <div th:insert="~{/navTemplate :: navbar}"></div>

      <div class="main-content act-page">
        <div
          th:insert="~{/subnavActFront :: subnav('search')}"
        ></div>
        <div class="content-area-main act-area">
          <h1 class="act-front-title">搜尋活動</h1>
          <!-- 搜尋區域 -->
          <div class="act-search-container">
            <form id="searchForm" class="act-search-form">
              <div class="act-search-group">
                <label class="act-search-label">活動名稱</label>
                <input
                  type="text"
                  name="actName"
                  class="act-search-input"
                  placeholder="輸入活動名稱關鍵字"
                />
              </div>

              <div class="act-search-group">
                <label class="act-search-label">招募狀態</label>
                <select name="recruitStatus" class="act-search-input">
                  <option value="">全部狀態</option>
                  <option value="0">招募中</option>
                  <option value="1">成團</option>
                  <option value="2">未成團</option>
                  <option value="3">已取消</option>
                  <option value="4">已凍結</option>
                  <option value="5">已結束</option>
                </select>
              </div>

              <div class="act-search-group">
                <label class="act-search-label">公開狀態</label>
                <select name="isPublic" class="act-search-input">
                  <option value="">全部</option>
                  <option value="1">公開</option>
                  <option value="0">私人</option>
                </select>
              </div>

              <div class="act-search-group">
                <label class="act-search-label">活動開始時間</label>
                <input
                  type="datetime-local"
                  name="actStart"
                  class="act-search-input"
                />
              </div>

              <div class="act-search-group">
                <label class="act-search-label">人數上限</label>
                <input
                  type="number"
                  name="maxCap"
                  class="act-search-input"
                  placeholder="最少人數"
                />
              </div>

              <div class="act-search-actions">
                <button type="submit" class="act-btn act-btn-primary">
                  搜尋活動
                </button>
                <button
                  type="button"
                  onclick="loadAllActivities()"
                  class="act-btn act-btn-secondary"
                >
                  顯示全部
                </button>

                <!-- ======================================== -->
                <!-- 測試相關按鈕 - 開發完成後可移除 -->
                <!-- ======================================== -->
                <button
                  type="button"
                  onclick="testApi()"
                  class="act-btn act-btn-secondary"
                  style="background-color: #ff9800"
                >
                  測試 API
                </button>
                <button
                  type="button"
                  onclick="testImageResponse()"
                  class="act-btn act-btn-secondary"
                  style="background-color: #ff9800"
                >
                  測試圖片回傳
                </button>
              </div>
            </form>
          </div>

          <!-- 搜尋結果 -->
          <div id="searchResults" class="act-loading" style="display: none">
            載入中...
          </div>

          <!-- 初始狀態 -->
          <div
            id="initialState"
            style="
              text-align: center;
              padding: 40px;
              color: var(--md-sys-color-on-surface-variant);
            "
          >
            <h3>開始搜尋活動</h3>
            <p>使用上方的搜尋條件來找到您感興趣的活動</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const searchForm = document.getElementById("searchForm");
      const searchResults = document.getElementById("searchResults");
      const initialState = document.getElementById("initialState");

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("zh-TW", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
      }

      function getStatusText(status) {
        const statusMap = {
          0: { text: "招募中", class: "recruiting" },
          1: { text: "成團", class: "full" },
          2: { text: "未成團", class: "ended" },
          3: { text: "已取消", class: "ended" },
          4: { text: "已凍結", class: "ended" },
          5: { text: "已結束", class: "ended" },
        };
        return statusMap[status] || { text: "未知", class: "ended" };
      }

      // 查看活動詳情
      function viewAct(actId) {
        window.location.href = `/act/member/view/${actId}`;
      }

      function createActCard(act) {
        const status = getStatusText(act.recruitStatus);
        let imageHtml = '<div class="act-card-image-placeholder">無圖片</div>';

        // 檢查是否有圖片資料
        if (act.actImg && act.actImg.length > 0) {
          // 使用圖片端點直接顯示 byte[] 圖片，現在會自動顯示預設圖片
          imageHtml = `<img src="/act/member/image/${act.actId}" alt="活動圖片" class="act-card-image">`;
        } else {
          console.log("沒有圖片資料，將顯示預設圖片");
        }

        return `
                <div class="act-card">
                    ${imageHtml}
                    <h3 class="act-card-title">${
                      act.actName || "未命名活動"
                    }</h3>
                    <p class="act-card-desc">${act.actDesc || "無描述"}</p>
                    
                    <div class="act-card-info">
                        <div class="act-info-item">
                            <span class="act-info-label">人數</span>
                            <span class="act-info-value">${
                              act.signupCnt || 0
                            }/${act.maxCap || 0}</span>
                        </div>
                        <div class="act-info-item">
                            <span class="act-info-label">開始日期</span>
                            <span class="act-info-value">${
                              act.actStart ? formatDate(act.actStart) : "未設定"
                            }</span>
                        </div>
                    </div>
                    
                    <span class="act-status ${status.class}">${
          status.text
        }</span>
                    
                    <div class="act-card-actions">
                        <button onclick="viewAct(${
                          act.actId
                        })" class="act-btn act-btn-primary">
                            查看詳情
                        </button>
                    </div>
                </div>
            `;
      }

      function buildSearchUrl(formData) {
        const params = new URLSearchParams();

        if (formData.get("actName"))
          params.append("actName", formData.get("actName"));
        if (formData.get("recruitStatus"))
          params.append("recruitStatus", formData.get("recruitStatus"));
        if (formData.get("isPublic"))
          params.append("isPublic", formData.get("isPublic"));
        if (formData.get("actStart"))
          params.append("actStart", formData.get("actStart"));
        if (formData.get("maxCap"))
          params.append("maxCap", formData.get("maxCap"));

        return `/api/act/search/all?${params.toString()}`;
      }

      searchForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(searchForm);
        const searchUrl = buildSearchUrl(formData);

        // 顯示載入狀態
        initialState.style.display = "none";
        searchResults.style.display = "block";
        searchResults.innerHTML = '<div class="act-loading">搜尋中...</div>';

        fetch(searchUrl)
          .then((r) => r.json())
          .then((data) => {
            console.log("搜尋結果:", data); // 除錯用
            if (data && data.length > 0) {
              searchResults.innerHTML = `
                            <div class="act-card-container">
                                ${data.map(createActCard).join("")}
                            </div>
                            <div style="text-align: center; margin-top: 24px; color: var(--md-sys-color-on-surface-variant);">
                                總計 ${data.length} 個活動
                            </div>
                        `;
            } else {
              searchResults.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--md-sys-color-on-surface-variant);">
                                <h3>沒有找到符合條件的活動</h3>
                                <p>請嘗試調整搜尋條件</p>
                            </div>
                        `;
            }
          })
          .catch((error) => {
            console.error("搜尋失敗:", error);
            searchResults.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--md-sys-color-error);">
                            <h3>搜尋失敗</h3>
                            <p>無法執行搜尋，請稍後再試</p>
                            <p>錯誤訊息: ${error.message}</p>
                        </div>
                    `;
          });
      });

      // 載入所有活動作為預設顯示
      function loadAllActivities() {
        initialState.style.display = "none";
        searchResults.style.display = "block";
        searchResults.innerHTML = '<div class="act-loading">載入中...</div>';

        // 使用不分頁的搜尋 API
        fetch("/api/act/search/all")
          .then((r) => r.json())
          .then((data) => {
            console.log("API 回應:", data); // 除錯用
            searchResults.classList.remove("act-loading");
            if (data && data.length > 0) {
              searchResults.innerHTML = `
                            <div class="act-card-container">
                                ${data.map(createActCard).join("")}
                            </div>
                            <div style="text-align: center; margin-top: 24px; color: var(--md-sys-color-on-surface-variant);">
                                總計 ${data.length} 個活動
                            </div>
                        `;
            } else {
              searchResults.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--md-sys-color-on-surface-variant);">
                                <h3>目前沒有活動</h3>
                                <p>請稍後再來查看</p>
                                <button onclick="createTestData()" class="act-btn act-btn-primary">建立測試資料</button>
                            </div>
                        `;
            }
          })
          .catch((error) => {
            searchResults.classList.remove("act-loading");
            console.error("載入活動失敗:", error);
            searchResults.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--md-sys-color-error);">
                            <h3>載入失敗</h3>
                            <p>無法載入活動列表，請稍後再試</p>
                            <p>錯誤訊息: ${error.message}</p>
                        </div>
                    `;
          });
      }

      // ========================================
      // 測試相關函數 - 開發完成後可移除
      // ========================================

      // 建立測試資料
      function createTestData() {
        fetch("/test")
                .then((r) => r.json())
                .then((data) => {
            alert("測試資料建立成功！");
            loadAllActivities(); // 重新載入
          })
                .catch((error) => {
            console.error("建立測試資料失敗:", error);
            alert("建立測試資料失敗: " + error.message);
          });
      }

      /**
       * 測試 API 連線
       * 用途：檢查 API 端點是否正常運作
       * 移除時機：開發完成後
       */
      function testApi() {
        console.log("開始測試 API...");

        // 測試 debug 端點
        fetch("/api/act/debug")
          .then((r) => r.json())
          .then((data) => {
            console.log("Debug API 回應:", data);
            alert(
              `資料庫狀態:\n總計: ${data.totalCount} 個活動\n時間: ${data.timestamp}`
            );
          })
          .catch((error) => {
            console.error("Debug API 失敗:", error);
            alert("Debug API 失敗: " + error.message);
          });
      }

      /**
       * 測試圖片回傳
       * 用途：檢查圖片端點是否正常運作
       * 移除時機：開發完成後
       */
      function testImageResponse() {
        console.log("開始測試圖片回傳...");

        // 先取得第一個活動的 ID
        fetch("/api/act/search/all")
          .then((r) => r.json())
          .then((data) => {
            if (data && data.length > 0) {
              const firstAct = data[0];
              console.log("測試活動:", firstAct.actId, firstAct.actName);

              // 測試圖片回傳端點
              return fetch(`/api/act/test-image-response/${firstAct.actId}`);
            } else {
              throw new Error("沒有活動資料可測試");
            }
          })
          .then((r) => r.json())
          .then((data) => {
            console.log("圖片回傳測試結果:", data);
            alert(
              `圖片回傳測試結果:\n` +
                `活動ID: ${data.actId}\n` +
                `活動名稱: ${data.actName}\n` +
                `有 actImg: ${data.hasActImg}\n` +
                `actImg 長度: ${data.actImgLength}\n` +
                `訊息: ${data.message}`
            );
          })
          .catch((error) => {
            console.error("圖片回傳測試失敗:", error);
            alert("圖片回傳測試失敗: " + error.message);
          });
      }

      // 頁面載入時顯示所有活動
      loadAllActivities();
    </script>
  </body>
</html>
