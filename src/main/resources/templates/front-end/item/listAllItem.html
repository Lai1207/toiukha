<!DOCTYPE html>
<html lang="ZH-Hant" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>島遊Kha - 商品列表</title>
    <th:block th:replace="~{/navTemplate :: headResources}"></th:block>
    <link rel="stylesheet" th:href="@{/css/header_style.css}">
    <style>
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .card {
            width: 200px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 8px;
            text-align: center;
            transition: transform 0.3s ease;
            font-size: 12px;
            cursor: pointer;
        }

        .card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .card:hover {
            transform: scale(1.05);
        }

        .add-to-cart-btn {
            background-color: #1976d2 !important;
            color: white !important;
            padding: 4px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px 0;
            transition: background 0.2s;
            height: 32px;
        }

        .add-to-cart-btn:hover {
            background-color: #1565c0 !important;
        }

        .add-to-favorite-btn {
            height: 32px;
            width: 32px;
            background: none;
            color: #FFD600;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .add-to-favorite-btn:hover {
            transform: scale(1.1);
            color: #FFA000;
        }
        
        .add-to-favorite-btn.favorited {
            color: #FF6B6B;
        }
        
        .add-to-favorite-btn.favorited:hover {
            color: #FF5252;
        }
        
        .add-to-favorite-btn.processing {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .add-to-favorite-btn.processing i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal 樣式 */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 24px 32px 18px 32px;
            max-width: 400px;
            width: 90vw;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
            position: relative;
            text-align: center;
        }

        .modal-content img {
            width: 80%;
            max-width: 300px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 24px;
            color: #888;
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal-content h4 {
            margin: 0 0 8px 0;
            color: #1976d2;
        }

        .modal-content p {
            margin: 8px 0;
        }

        #cart-fab {
            position: fixed;
            right: 32px;
            bottom: 32px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #1976d2;
            color: #fff;
            border: none;
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            z-index: 1000;
            transition: background 0.2s, box-shadow 0.2s;
        }

        #cart-fab:hover {
            background: #1565c0;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.35);
        }

        #cart-fab .material-icons {
            font-size: 32px;
        }

        /* 圖片輪播樣式 */
        .carousel-container {
            position: relative;
            max-width: 1200px; /* 限制最大寬度以維持良好比例 */
            width: 100%;
            margin: 0 auto 32px auto;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .carousel-container:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .carousel-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 6 / 4; /* 6:4 橫式比例 */
            max-height: 400px; /* 限制最大高度 */
            min-height: 250px; /* 限制最小高度 */
        }

        /* 針對不支援 aspect-ratio 的舊瀏覽器的備用方案 */
        @supports not (aspect-ratio: 1) {
            .carousel-wrapper {
                height: 300px; /* 備用固定高度 */
            }
            
            @media (max-width: 768px) {
                .carousel-wrapper {
                    height: 200px; /* 手機版備用高度 */
                }
            }
        }

        .carousel-slide {
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .carousel-slide.active {
            display: block;
            opacity: 1;
        }

        .carousel-slide:hover {
            transform: scale(1.02);
            transition: transform 0.3s ease;
        }

        .carousel-slide:hover .carousel-caption {
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
        }

        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 保持原比例填滿容器 */
            object-position: center; /* 圖片居中顯示 */
            border-radius: 12px;
            transition: transform 0.3s ease; /* 添加滑順的縮放動畫 */
        }

        .carousel-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 40px 32px 24px 32px;
            text-align: left;
        }

        .carousel-caption h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .carousel-caption p {
            font-size: 1.1rem;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .carousel-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-btn-prev {
            left: 20px;
        }

        .carousel-btn-next {
            right: 20px;
        }

        .carousel-btn .material-icons {
            font-size: 24px;
            color: #1976d2;
        }

        .carousel-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 10;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .indicator.active {
            background: #fff;
            transform: scale(1.2);
        }

        .indicator:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        .carousel-click-hint {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .carousel-container:hover .carousel-click-hint {
            opacity: 1;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .carousel-wrapper {
                min-height: 180px; /* 手機版較小的最小高度 */
                max-height: 280px; /* 手機版較小的最大高度 */
            }

            .carousel-caption {
                padding: 20px 16px 16px 16px;
            }

            .carousel-caption h3 {
                font-size: 1.4rem;
            }

            .carousel-caption p {
                font-size: 0.95rem;
            }

            .carousel-btn {
                width: 40px;
                height: 40px;
            }

            .carousel-btn-prev {
                left: 10px;
            }

            .carousel-btn-next {
                right: 10px;
            }

            .carousel-btn .material-icons {
                font-size: 20px;
            }

            .carousel-click-hint {
                bottom: -25px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body class="light">

    <div class="app-container">
        <div th:insert="~{/navTemplate :: navbar}"></div>
        <div class="main-content">
            <header class="secondary-nav">
                <div th:insert="~{/subnavStore_front::subnav(${activeItem})}"></div>
            </header>
            <main class="content-area-main">
                <input type="hidden" name="memId" th:value="${session.member != null ? session.member.memId : ''}">
                <div id="ad">
                    <div class="carousel-container">
                        <div class="carousel-wrapper">
                            <th:block th:each="ad, status : ${ads}">
                                <div class="carousel-slide" th:classappend="${status.index == 0 ? 'active' : ''}"
                                    th:attr="data-store-id=${ad.storeId}" style="cursor: pointer;">
                                    <img th:src="@{/advertisment/DBGifReader(adId=${ad.adId})}" th:alt="${ad.adTitle}"
                                        onerror="this.src='https://picsum.photos/800/300?random=1'">
                                    <div class="carousel-caption">
                                        <h3 th:text="${ad.adTitle}"></h3>
                                        <p style="font-size: 0.9rem; margin-top: 8px; opacity: 0.8;">
                                            <i class="fa fa-mouse-pointer" style="margin-right: 5px;"></i>
                                            點擊查看商店商品
                                        </p>
                                    </div>
                                </div>
                            </th:block>
                        </div>

                        <button class="carousel-btn carousel-btn-prev" onclick="changeSlide(-1)">
                            <span class="material-icons">chevron_left</span>
                        </button>
                        <button class="carousel-btn carousel-btn-next" onclick="changeSlide(1)">
                            <span class="material-icons">chevron_right</span>
                        </button>

                        <div class="carousel-indicators">
                            <th:block th:each="ad, status : ${ads}">
                                <span class="indicator" th:classappend="${status.index == 0 ? 'active' : ''}"
                                    th:onclick="'currentSlide(' + (${status.index} + 1) + ')'"></span>
                            </th:block>
                        </div>

                        <!-- 點擊提示 -->
                        <div class="carousel-click-hint">
                            <i class="fa fa-hand-pointer-o" style="margin-right: 5px;"></i>
                            點擊廣告查看商店商品
                        </div>
                    </div>
                </div>
                <div class="item-search-bar"
                    style="display:flex;align-items:center;background:#fff;border-radius:24px;box-shadow:0 2px 8px rgba(25,118,210,0.10);padding:4px 16px;width:520px;margin:0 auto 24px auto;border:1.5px solid #bdbdbd;transition:border 0.2s;">
                    <span class="material-icons" style="color:#1976d2;font-size:1.5rem;margin-right:8px;">search</span>
                    <input type="text" id="itemSearchInput" placeholder="搜尋票券"
                        style="border:none;outline:none;font-size:1.08rem;background:transparent;width:100%;padding:8px 0;">
                </div>
                <div class="container" style="display:flex;flex-direction:column;gap:28px;padding:24px 0;">
                    <th:block th:each="itemVO : ${itemListData_front}">
                        <div class="card item-row"
                            th:attr="data-itemid=${itemVO.itemId},data-itemname=${itemVO.itemName},data-iteminfo=${itemVO.itemInfo},data-itemprice=${itemVO.itemPrice},data-discprice=${itemVO.discPrice},data-statime=${itemVO.staTime},data-endtime=${itemVO.endTime},data-imgsrc=@{/item/DBGifReader} + '?itemId=' + ${itemVO.itemId}"
                            style="display:flex;flex-direction:row;align-items:center;gap:22px;width:100%;max-width:900px;margin:0 auto;padding:18px 18px 18px 0;text-align:left;">
                            <div style="flex:0 0 240px;max-width:240px;">
                                <img th:src="@{/item/DBGifReader} + '?itemId=' + ${itemVO.itemId}" alt="商品圖片"
                                    style="width:100%;height:180px;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px #1976d233;">
                            </div>
                            <div style="flex:1 1 auto;display:flex;flex-direction:column;gap:6px;">
                                <h4 th:text="${itemVO.itemName}"
                                    style="color:#1976d2;font-size:1.18rem;font-weight:600;margin:0 0 6px 0;"></h4>
                                <p style="color:#666;margin:0 0 4px 0;min-height:32px;"
                                    th:text="${#strings.length(itemVO.itemInfo) > 30} ? ${#strings.substring(itemVO.itemInfo, 0, 30)} + '...' : ${itemVO.itemInfo}">
                                </p>
                                <p style="margin:0 0 8px 0;">
                                    <span
                                        th:if="${itemVO.discPrice != null} and ${itemVO.staTime != null} and ${itemVO.endTime != null} and ${#temporals.createNow().isAfter(itemVO.staTime)} and ${#temporals.createNow().isBefore(itemVO.endTime)}">
                                        <span style="text-decoration: line-through; color: #888; font-size:1.05rem;">原價:
                                            $<span th:text="${itemVO.itemPrice}"></span></span>
                                        <span
                                            style="color: #d32f2f; font-weight: bold; margin-left: 6px; font-size:1.18rem;">促銷價:
                                            $<span th:text="${itemVO.discPrice}"></span></span>
                                    </span>
                                    <span
                                        th:if="${itemVO.discPrice == null} or ${itemVO.staTime == null} or ${itemVO.endTime == null} or ${#temporals.createNow().isBefore(itemVO.staTime)} or ${#temporals.createNow().isAfter(itemVO.endTime)}">
                                        <span style="color:#1976d2;font-weight:700;font-size:1.18rem;">$<span
                                                th:text="${itemVO.itemPrice}"></span></span>
                                    </span>
                                </p>
                                <form method="post" th:action="@{/item/add_to_shopCart}" class="shopping-cart-form"
                                    style="display: flex; align-items: center; gap: 6px; margin-top:8px;">
                                    <input type="hidden" name="itemId" th:value="${itemVO.itemId}">
                                    <input type="hidden" name="memId"
                                        th:value="${session.member != null ? session.member.memId : ''}">
                                    <input type="number" name="quantity" class="quantity-input" min="1" max="99"
                                        value="1"
                                        style="width: 50px; height: 28px; border-radius: 4px; border: 1px solid #ccc; text-align: center; margin-right: 4px;" />
                                    <button type="button" class="add-to-cart-btn">加入購物車</button>
                                    <button type="button" class="add-to-favorite-btn"
                                        th:attr="data-itemid=${itemVO.itemId},data-memid=${session.member != null ? session.member.memId : ''}">
                                        <i class="fa-regular fa-star"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </th:block>
                </div>
                <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
                <script>
                    // 圖片輪播相關變數
                    let currentSlideIndex = 0;
                    let slideInterval;
                    const slides = document.querySelectorAll('.carousel-slide');
                    const indicators = document.querySelectorAll('.indicator');
                    const totalSlides = slides.length;

                    // 顯示指定索引的幻燈片
                    function showSlide(index) {
                        // 隱藏所有幻燈片
                        slides.forEach(slide => {
                            slide.classList.remove('active');
                        });

                        // 移除所有指示器的active狀態
                        indicators.forEach(indicator => {
                            indicator.classList.remove('active');
                        });

                        // 確保索引在有效範圍內
                        if (index >= totalSlides) {
                            currentSlideIndex = 0;
                        } else if (index < 0) {
                            currentSlideIndex = totalSlides - 1;
                        } else {
                            currentSlideIndex = index;
                        }

                        // 顯示當前幻燈片和指示器
                        slides[currentSlideIndex].classList.add('active');
                        indicators[currentSlideIndex].classList.add('active');
                    }

                    // 切換到下一張或上一張幻燈片
                    function changeSlide(direction) {
                        const newIndex = currentSlideIndex + direction;
                        showSlide(newIndex);
                        resetAutoSlide();
                    }

                    // 切換到指定編號的幻燈片
                    function currentSlide(slideNumber) {
                        showSlide(slideNumber - 1);
                        resetAutoSlide();
                    }

                    // 自動播放功能
                    function autoSlide() {
                        currentSlideIndex++;
                        if (currentSlideIndex >= totalSlides) {
                            currentSlideIndex = 0;
                        }
                        showSlide(currentSlideIndex);
                    }

                    // 開始自動播放
                    function startAutoSlide() {
                        slideInterval = setInterval(autoSlide, 5000); // 每5秒切換一次
                    }

                    // 停止自動播放
                    function stopAutoSlide() {
                        clearInterval(slideInterval);
                    }

                    // 重置自動播放
                    function resetAutoSlide() {
                        stopAutoSlide();
                        startAutoSlide();
                    }

                    // 初始化輪播
                    function initCarousel() {
                        if (totalSlides > 0) {
                            // 不再需要手動設定第一張為 active，因為 Thymeleaf 會處理
                            // showSlide(0); // 這裡不需要再呼叫，因為 Thymeleaf 已經設定好初始 active
                            startAutoSlide();

                            // 當滑鼠懸停在輪播上時暫停自動播放
                            const carouselContainer = document.querySelector('.carousel-container');
                            if (carouselContainer) {
                                carouselContainer.addEventListener('mouseenter', stopAutoSlide);
                                carouselContainer.addEventListener('mouseleave', startAutoSlide);
                            }
                        }
                    }

                    // 使函數可全域訪問
                    window.changeSlide = changeSlide;
                    window.currentSlide = currentSlide;

                    // Toast 提示功能
                    function showToast(message, type = 'info') {
                        // 移除現有的 toast
                        $('.toast-message').remove();
                        
                        var colors = {
                            'success': '#4CAF50',
                            'error': '#F44336',
                            'info': '#2196F3',
                            'warning': '#FF9800'
                        };
                        
                        var toast = $('<div class="toast-message">' + message + '</div>');
                        toast.css({
                            'position': 'fixed',
                            'top': '20px',
                            'right': '20px',
                            'background': colors[type] || colors.info,
                            'color': 'white',
                            'padding': '12px 20px',
                            'border-radius': '8px',
                            'box-shadow': '0 4px 12px rgba(0,0,0,0.2)',
                            'z-index': '9999',
                            'font-size': '14px',
                            'opacity': '0',
                            'transform': 'translateX(100%)',
                            'transition': 'all 0.3s ease'
                        });
                        
                        $('body').append(toast);
                        
                        // 動畫顯示
                        setTimeout(function() {
                            toast.css({
                                'opacity': '1',
                                'transform': 'translateX(0)'
                            });
                        }, 100);
                        
                        // 3秒後自動消失
                        setTimeout(function() {
                            toast.css({
                                'opacity': '0',
                                'transform': 'translateX(100%)'
                            });
                            setTimeout(function() {
                                toast.remove();
                            }, 300);
                        }, 3000);
                    }

                    // 初始化收藏狀態
                    function initFavoriteStatus() {
                        var memId = $('input[name="memId"]').val();
                        if (!memId || memId === '' || memId === 'null' || memId === 'undefined') {
                            return; // 未登入用戶不需要檢查收藏狀態
                        }
                        
                        // 收集所有商品ID
                        var itemIds = [];
                        $('.add-to-favorite-btn').each(function() {
                            var itemId = $(this).data('itemid');
                            if (itemId) {
                                itemIds.push(itemId);
                            }
                        });
                        
                        // 批量檢查收藏狀態
                        if (itemIds.length > 0) {
                            $.ajax({
                                url: '/productfav/check_favorites_batch',
                                type: 'POST',
                                data: { 
                                    memId: memId,
                                    itemIds: itemIds.join(',')
                                },
                                success: function(response) {
                                    if (typeof response === 'string') {
                                        try {
                                            response = JSON.parse(response);
                                        } catch (e) {
                                            console.error('解析收藏狀態響應失敗:', e);
                                            return;
                                        }
                                    }
                                    
                                    // 更新每個商品的收藏狀態
                                    $('.add-to-favorite-btn').each(function() {
                                        var $btn = $(this);
                                        var itemId = $btn.data('itemid');
                                        var isFavorited = response[itemId] === true;
                                        
                                        updateFavoriteButton($btn, isFavorited);
                                    });
                                },
                                error: function(xhr, status, error) {
                                    console.error('檢查收藏狀態失敗:', error);
                                }
                            });
                        }
                    }
                    
                    // 更新收藏按鈕狀態
                    function updateFavoriteButton($btn, isFavorited) {
                        var $icon = $btn.find('i');
                        
                        if (isFavorited) {
                            $icon.removeClass('fa-regular fa-star').addClass('fa-solid fa-star');
                            $btn.addClass('favorited');
                        } else {
                            $icon.removeClass('fa-solid fa-star').addClass('fa-regular fa-star');
                            $btn.removeClass('favorited');
                        }
                    }
                    
                    // 更新頁面上所有相同商品的收藏狀態
                    function updateAllItemFavoriteStatus(itemId, isFavorited) {
                        // 更新商品卡片中的收藏按鈕
                        $('.add-to-favorite-btn[data-itemid="' + itemId + '"]').each(function() {
                            updateFavoriteButton($(this), isFavorited);
                        });
                        
                        // 更新模態框中的收藏按鈕（如果存在）
                        $('#item-modal-backdrop .add-to-favorite-btn[data-itemid="' + itemId + '"]').each(function() {
                            updateFavoriteButton($(this), isFavorited);
                        });
                    }

                    $(document).ready(function () {
                        // 初始化輪播功能
                        initCarousel();
                        
                        // 初始化收藏狀態
                        initFavoriteStatus();

                        // 為輪播幻燈片添加點擊事件（使用事件委派）
                        $(document).on('click', '.carousel-slide', function (e) {
                            // 如果點擊的是箭頭按鈕或導航點，則不處理
                            if ($(e.target).closest('.carousel-btn, .carousel-indicators').length > 0) {
                                return;
                            }

                            var storeId = $(this).data('store-id');
                            console.log('廣告點擊，商店ID:', storeId); // 調試信息

                            if (storeId && storeId !== 'undefined' && storeId !== null) {
                                // 導航到商店頁面
                                window.location.href = '/advertisment/storeItems?storeId=' + storeId;
                            } else {
                                console.warn('廣告沒有有效的商店ID');
                                // 可選：顯示提示信息
                                alert('很抱歉，該廣告暫時無法連接到商店頁面。');
                            }
                        });
                        // 收藏功能
                        $(document).on('click', '.add-to-favorite-btn', function (e) {
                            e.stopPropagation();
                            var $btn = $(this);
                            var itemId = $btn.data('itemid');
                            var memId = $btn.data('memid');
                            
                            if (!memId || memId === '' || memId === 'null' || memId === 'undefined') {
                                // 跳轉到登入頁面並帶上 redirect 參數
                                window.location.href = '/members/login?redirect=' + encodeURIComponent('/item/listAllItem');
                                return;
                            }
                            
                            // 防止重複點擊
                            if ($btn.hasClass('processing')) return;
                            $btn.addClass('processing');
                            
                            $.ajax({
                                url: '/productfav/add_to_favorite',
                                type: 'POST',
                                data: { itemId: itemId, memId: memId },
                                success: function (response) {
                                    if (response === 'success') {
                                        // 加入收藏成功 - 更新所有相同商品的收藏狀態
                                        updateAllItemFavoriteStatus(itemId, true);
                                        showToast('已加入收藏！', 'success');
                                    } else if (response === '取消收藏') {
                                        // 取消收藏成功 - 更新所有相同商品的收藏狀態
                                        updateAllItemFavoriteStatus(itemId, false);
                                        showToast('已取消收藏！', 'info');
                                    } else {
                                        showToast(response, 'error');
                                    }
                                },
                                error: function (xhr, status, error) {
                                    showToast('操作失敗，請稍後再試！', 'error');
                                },
                                complete: function() {
                                    $btn.removeClass('processing');
                                }
                            });
                        });
                        $('#cart-fab').click(function () {
                            var memId = $('input[name="memId"]').val();
                            if (!memId || memId === '' || memId === 'null' || memId === 'undefined') {
                                // 跳轉到登入頁面並帶上 redirect 參數
                                window.location.href = '/members/login?redirect=' + encodeURIComponent('/item/listAllItem');
                                return;
                            }

                            // 先獲取購物車內容
                            $.ajax({
                                url: '/item/get_cart_detail',
                                type: 'POST',
                                data: { memId: memId },
                                success: function (cartList) {
                                    // 再獲取會員優惠券
                                    $.ajax({
                                        url: '/item/get_member_coupons',
                                        type: 'POST',
                                        data: { memId: memId },
                                        success: function (memberCoupons) {
                                            displayCartModal(cartList, memberCoupons, memId);
                                        },
                                        error: function () {
                                            displayCartModal(cartList, [], memId);
                                        }
                                    });
                                },
                                error: function () {
                                    alert('取得購物車失敗，請稍後再試！');
                                }
                            });
                        });

                        function displayCartModal(cartList, memberCoupons, memId) {
                            // 先加霧化背景
                            if (!document.getElementById('cart-blur-bg')) {
                                var blurBg = document.createElement('div');
                                blurBg.id = 'cart-blur-bg';
                                blurBg.style.position = 'fixed';
                                blurBg.style.top = '0';
                                blurBg.style.left = '0';
                                blurBg.style.width = '100vw';
                                blurBg.style.height = '100vh';
                                blurBg.style.background = 'rgba(0,0,0,0.18)';
                                blurBg.style.backdropFilter = 'blur(6px)';
                                blurBg.style.zIndex = '1999';
                                blurBg.style.transition = 'opacity 0.2s';
                                document.body.appendChild(blurBg);
                            }
                            var html = '<div id="cart-modal" style="position:fixed;top:8%;left:50%;transform:translateX(-50%);background:#fff;padding:38px 32px;border-radius:18px;box-shadow:0 8px 32px rgba(0,0,0,0.18);z-index:2000;max-height:86vh;overflow-y:auto;min-width:420px;max-width:540px;width:96vw;font-size:1.18rem;">';
                            html += '<h3 style="color:#1976d2;font-size:1.55rem;margin-bottom:18px;">購物車內容</h3>';

                            if (cartList.length === 0) {
                                html += '<p style="font-size:1rem;">購物車是空的</p>';
                            } else {
                                // 計算購物車中商品的商店ID
                                var storeIds = new Set();
                                cartList.forEach(function (item) {
                                    if (item.storeId) {
                                        storeIds.add(item.storeId);
                                    }
                                });

                                html += '<table style="width:100%;font-size:1.13rem;"><tr><th></th><th>商品名稱</th><th>單價</th><th>數量</th></tr>';
                                var total = 0;
                                cartList.forEach(function (item) {
                                    var price = parseFloat(item.price);
                                    var imgSrc = '/item/DBGifReader?itemId=' + item.itemId;
                                    html += '<tr data-itemid="' + item.itemId + '">';
                                    html += '<td style="padding:10px 0;"><img src="' + imgSrc + '" alt="商品圖片" style="width:68px;height:68px;border-radius:8px;object-fit:cover;"></td>';
                                    html += '<td style="padding:10px 0;">' + item.itemName + '</td>';
                                    html += '<td style="padding:10px 0;">' + price + '</td>';
                                    html += '<td style="padding:10px 0;"><input type="number" class="cart-qty-input" value="' + item.quantity + '" min="1" style="width:60px;height:36px;font-size:1.1rem;text-align:center;border-radius:6px;border:1.5px solid #ccc;"/></td>';
                                    html += '<td><button class="remove-cart-btn" style="color:#fff;background:#d32f2f;border:none;border-radius:6px;padding:4px 16px;font-size:1.08rem;">移除</button></td>';
                                    html += '</tr>';
                                    total += price * item.quantity;
                                });
                                html += '</table>';

                                // 優惠券選擇區域：檢查會員是否有優惠券
                                if (memberCoupons.length > 0) {
                                    html += '<div style="margin-top:20px;border-top:1px solid #eee;padding-top:20px;">';
                                    html += '<h4 style="color:#1976d2;margin-bottom:10px;">選擇優惠券</h4>';
                                    html += '<select id="coupon-select" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin-bottom:10px;">';
                                    html += '<option value="">不使用優惠券</option>';

                                    // 遍歷所有會員優惠券
                                    memberCoupons.forEach(function (coupon) {
                                        // 檢查此優惠券的商家是否與購物車中的任一商品商家匹配
                                        var isApplicable = false;
                                        storeIds.forEach(function (storeId) {
                                            if (coupon.storeId === storeId) {
                                                isApplicable = true; // 若匹配，標記為適用
                                            }
                                        });

                                        // 如果優惠券適用，則將其添加到下拉選單中
                                        if (isApplicable) {
                                            html += '<option value="' + coupon.couId + '" data-discount="' + coupon.discValue + '">';
                                            html += coupon.couName + ' (折抵 ' + coupon.discValue + ' 元)';
                                            html += '</option>';
                                        }
                                    });

                                    html += '</select>';
                                    html += '</div>';
                                } else {
                                    // 若會員沒有任何優惠券，顯示提示訊息
                                    html += '<div style="margin-top:20px;border-top:1px solid #eee;padding-top:20px;">';
                                    html += '<p style="color:#666;">您目前沒有可用的優惠券</p>';
                                    html += '</div>';
                                }

                                // 總金額顯示區域
                                html += '<div style="text-align:right;font-size:1.08rem;margin:10px 0;color:#d32f2f;">';
                                html += '原價：<span id="cart-original-total">' + total + '</span> 元<br>';
                                html += '優惠券折抵：<span id="coupon-discount">0</span> 元<br>';
                                html += '總金額：<span id="cart-total-amount">' + total + '</span> 元';
                                html += '</div>';

                                // 結帳表單
                                html += '<form id="checkout-form" method="post" action="/order/checkout">';
                                html += '<input type="hidden" name="memId" value="' + memId + '"/>';
                                html += '<input type="hidden" name="selectedCouponId" id="selected-coupon-id" value=""/>';
                                cartList.forEach(function (item, idx) {
                                    html += '<input type="hidden" name="items[' + idx + '].itemId" value="' + item.itemId + '"/>';
                                    html += '<input type="hidden" name="items[' + idx + '].price" value="' + item.price + '"/>';
                                    html += '<input type="hidden" name="items[' + idx + '].quantity" value="' + item.quantity + '"/>';
                                });
                                html += '<button type="submit" style="margin-top:16px;padding:7px 20px;border-radius:6px;background:#43a047;color:#fff;border:none;font-size:1rem;">結帳</button>';
                                html += '</form>';
                            }

                            html += '<button id="cart-modal-close-btn" style="margin-top:16px;padding:7px 20px;border-radius:6px;background:#1976d2;color:#fff;border:none;font-size:1rem;">關閉</button>';
                            html += '</div>';
                            $('#cart-modal').remove();
                            $('body').append(html);
                            // 關閉時移除霧化背景
                            $('#cart-modal-close-btn').on('click', function () {
                                $('#cart-modal').remove();
                                $('#cart-blur-bg').remove();
                            });
                            // 補上購物車事件綁定
                            bindCartEvents(memId);
                        }
                        /**
                         * 更新購物車總金額顯示
                         * 此函數會重新計算商品總價，並減去已選擇的優惠券折扣
                         */
                        function updateCartTotal() {
                            var total = 0;
                            // 遍歷購物車中的每一項商品以計算原始總價
                            $('#cart-modal table tr[data-itemid]').each(function () {
                                var tr = $(this);
                                var price = parseFloat(tr.find('td:nth-child(3)').text());
                                var quantity = parseInt(tr.find('.cart-qty-input').val());
                                if (!isNaN(price) && !isNaN(quantity)) {
                                    total += price * quantity;
                                }
                            });

                            // 獲取當前優惠券的折扣金額
                            var couponDiscount = parseInt($('#coupon-discount').text()) || 0;
                            // 計算最終總金額（原始總價 - 折扣），確保不為負數
                            var finalTotal = Math.max(0, total - couponDiscount);

                            // 更新頁面上的金額顯示
                            $('#cart-original-total').text(total);
                            $('#cart-total-amount').text(finalTotal);

                            // 更新結帳表單中的隱藏欄位，以確保提交的是最新的購物車內容
                            var checkoutForm = $('#checkout-form');
                            checkoutForm.find('input[name^="items"]').remove();
                            var newFormItemsHtml = '';
                            $('#cart-modal table tr[data-itemid]').each(function (idx) {
                                var tr = $(this);
                                var itemId = tr.data('itemid');
                                var price = parseFloat(tr.find('td:nth-child(3)').text());
                                var quantity = parseInt(tr.find('.cart-qty-input').val());
                                newFormItemsHtml += '<input type="hidden" name="items[' + idx + '].itemId" value="' + itemId + '"/>';
                                newFormItemsHtml += '<input type="hidden" name="items[' + idx + '].price" value="' + price + '"/>';
                                newFormItemsHtml += '<input type="hidden" name="items[' + idx + '].quantity" value="' + quantity + '"/>';
                            });
                            checkoutForm.find('button[type="submit"]').before(newFormItemsHtml);
                        }

                        /**
                         * 當購物車內容變更時（如移除商品），重新檢查並更新優惠券選項
                         * 此函數會重新從後端獲取購物車與優惠券資料
                         */
                        function updateCouponOptions() {
                            // 如果購物車已空，則隱藏優惠券區塊並重置相關數值
                            if ($('#cart-modal table tr[data-itemid]').length === 0) {
                                $('#coupon-select').closest('div').hide(); // 隱藏下拉選單的容器
                                $('#coupon-select').val(''); // 清空選擇
                                $('#coupon-discount').text('0'); // 折扣歸零
                                $('#selected-coupon-id').val(''); // 清除已選優惠券ID
                                updateCartTotal(); // 更新總金額
                                return; // 中斷執行
                            }

                            // 如果購物車中還有商品，則重新獲取購物車和優惠券資料
                            var memId = $('input[name="memId"]').val();
                            $.ajax({
                                url: '/item/get_cart_detail', // 獲取最新購物車詳情
                                type: 'POST',
                                data: { memId: memId },
                                success: function (cartList) {
                                    // 成功獲取購物車後，再獲取會員的優惠券
                                    $.ajax({
                                        url: '/item/get_member_coupons',
                                        type: 'POST',
                                        data: { memId: memId },
                                        success: function (memberCoupons) {
                                            // 使用最新的購物車和優惠券資料來更新下拉選單
                                            updateCouponSelect(cartList, memberCoupons);
                                        },
                                        error: function () {
                                            // 若獲取優惠券失敗，也嘗試用現有購物車資料更新
                                            updateCouponSelect(cartList, []);
                                        }
                                    });
                                },
                                error: function () {
                                    console.log('重新獲取購物車資料失敗');
                                }
                            });
                        }

                        /**
                         * 根據最新的購物車內容和會員優惠券，更新優惠券下拉選單
                         * @param {Array} cartList - 最新的購物車商品列表
                         * @param {Array} memberCoupons - 最新的會員優惠券列表
                         */
                        function updateCouponSelect(cartList, memberCoupons) {
                            // 重新計算當前購物車中所有商品的商家ID
                            var storeIds = new Set();
                            cartList.forEach(function (item) {
                                if (item.storeId) {
                                    storeIds.add(item.storeId);
                                }
                            });

                            var couponSelect = $('#coupon-select');
                            var currentSelectedCoupon = couponSelect.val(); // 記錄當前選擇的優惠券

                            // 清空現有選項，並加入預設選項
                            couponSelect.empty();
                            couponSelect.append('<option value="">不使用優惠券</option>');

                            // 遍歷優惠券，只顯示適用於當前購物車商家的選項
                            var hasApplicableCoupons = false;
                            memberCoupons.forEach(function (coupon) {
                                var isApplicable = false;
                                storeIds.forEach(function (storeId) {
                                    if (coupon.storeId === storeId) {
                                        isApplicable = true;
                                    }
                                });

                                if (isApplicable) {
                                    hasApplicableCoupons = true; // 標記有適用的優惠券
                                    var option = $('<option></option>')
                                        .val(coupon.couId)
                                        .attr('data-discount', coupon.discValue)
                                        .text(coupon.couName + ' (折抵 ' + coupon.discValue + ' 元)');
                                    couponSelect.append(option);
                                }
                            });

                            // 檢查先前選擇的優惠券是否仍然適用，若不適用則重置
                            if (currentSelectedCoupon && !couponSelect.find('option[value="' + currentSelectedCoupon + '"]').length) {
                                couponSelect.val(''); // 清空選擇
                                $('#coupon-discount').text('0'); // 折扣歸零
                                $('#selected-coupon-id').val(''); // 清除ID
                            }

                            // 根據是否有適用優惠券，決定顯示或隱藏優惠券區塊
                            var couponSection = couponSelect.closest('div');
                            if (hasApplicableCoupons) {
                                couponSection.show();
                            } else {
                                couponSection.hide();
                                couponSelect.val('');
                                $('#coupon-discount').text('0');
                                $('#selected-coupon-id').val('');
                            }

                            // 最後，更新一次總金額顯示
                            updateCartTotal();
                        }

                        /**
                         * 綁定購物車彈窗內的所有事件
                         * @param {string} memId - 會員ID
                         */
                        function bindCartEvents(memId) {
                            // 綁定優惠券下拉選單的變更事件
                            $('#coupon-select').on('change', function () {
                                var selectedOption = $(this).find('option:selected');
                                var discount = selectedOption.data('discount') || 0; // 獲取折扣金額
                                var couponId = $(this).val(); // 獲取優惠券ID

                                // 更新折扣顯示和隱藏的表單欄位
                                $('#coupon-discount').text(discount);
                                $('#selected-coupon-id').val(couponId);
                                updateCartTotal(); // 更新總金額
                            });

                            // 綁定移除商品按鈕的點擊事件
                            $('.remove-cart-btn').click(function () {
                                var tr = $(this).closest('tr');
                                var itemId = tr.data('itemid');
                                $.ajax({
                                    url: '/item/remove_from_cart',
                                    type: 'POST',
                                    data: { memId: memId, itemId: itemId },
                                    success: function (res) {
                                        if (res === 'success') {
                                            tr.remove(); // 從畫面上移除該商品
                                            updateCartTotal(); // 更新總金額
                                            // 因商品已變更，需重新檢查優惠券的適用性
                                            updateCouponOptions();
                                        } else {
                                            alert('移除失敗');
                                        }
                                    },
                                    error: function () { alert('移除失敗'); }
                                });
                            });

                            // 綁定商品數量輸入框的變更事件
                            $('.cart-qty-input').on('change', function () {
                                var tr = $(this).closest('tr');
                                var itemId = tr.data('itemid');
                                var qty = $(this).val();
                                $.ajax({
                                    url: '/item/update_cart_qty',
                                    type: 'POST',
                                    data: { memId: memId, itemId: itemId, quantity: qty },
                                    success: function (res) {
                                        if (res === 'success') {
                                            // 數量變更只影響總金額，不影響優惠券適用性
                                            updateCartTotal();
                                        } else {
                                            alert('更新失敗');
                                        }
                                    },
                                    error: function () { alert('更新失敗'); }
                                });
                            });
                        }
                        // 加入購物車功能
                        $(document).on('click', '.add-to-cart-btn', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            var form = $(this).closest('form');
                            var itemId = form.find('input[name="itemId"]').val();
                            var memId = form.find('input[name="memId"]').val();
                            var quantity = form.find('input[name="quantity"]').val();
                            if (!memId || memId === '' || memId === 'null' || memId === 'undefined') {
                                // 跳轉到登入頁面並帶上 redirect 參數
                                window.location.href = '/members/login?redirect=' + encodeURIComponent('/item/listAllItem');
                                return;
                            }
                            $.ajax({
                                url: form.attr('action'),
                                type: 'POST',
                                data: { itemId: itemId, memId: memId, quantity: quantity },
                                success: function (response) {
                                    if (response === 'success') {
                                        alert('商品已成功加入購物車！');
                                    } else {
                                        alert('加入購物車失敗：' + response);
                                    }
                                },
                                error: function (xhr, status, error) {
                                    alert('加入購物車失敗，請稍後再試！\n錯誤信息：' + error);
                                }
                            });
                        });

                        // 彈出商品詳細 modal
                        $(document).on('click', '.card, .card img', function (e) {
                            if ($(e.target).is('button') || $(e.target).is('input') || $(e.target).is('i')) return;
                            var card = $(this).closest('.card');
                            var itemId = card.data('itemid');
                            var itemName = card.data('itemname');
                            var itemInfo = card.data('iteminfo');
                            var itemPrice = card.data('itemprice');
                            var discPrice = card.data('discprice');
                            var staTime = card.data('statime');
                            var endTime = card.data('endtime');
                            var imgSrc = card.data('imgsrc');
                            var memId = $('input[name="memId"]').val();

                            var now = new Date();
                            var showDisc = false;
                            if (discPrice && staTime && endTime) {
                                var start = new Date(staTime);
                                var end = new Date(endTime);
                                if (now > start && now < end) showDisc = true;
                            }

                            // 檢查當前商品的收藏狀態
                            var cardFavoriteBtn = card.find('.add-to-favorite-btn');
                            var isFavorited = cardFavoriteBtn.hasClass('favorited');
                            var starIcon = isFavorited ? 'fa-solid fa-star' : 'fa-regular fa-star';
                            var favoriteClass = isFavorited ? 'favorited' : '';
                            
                            var modalHtml = `
                                <div class="modal-backdrop" id="item-modal-backdrop">
                                    <div class="modal-content" style="display:flex;flex-direction:row;align-items:center;gap:32px;min-width:620px;max-width:980px;padding:32px 32px 32px 0;text-align:left;">
                                        <div style="flex:0 0 320px;max-width:320px;">
                                            <img src="${imgSrc}" alt="商品圖片" style="width:100%;height:240px;object-fit:cover;border-radius:12px;box-shadow:0 4px 16px #1976d233;">
                                        </div>
                                        <div style="flex:1 1 auto;display:flex;flex-direction:column;gap:16px;">
                                            <h4 style="color:#1976d2;font-size:1.7rem;font-weight:700;margin:0 0 10px 0;">${itemName}</h4>
                                            <p style="color:#555;margin:0 0 8px 0;min-height:38px;font-size:1.18rem;">${itemInfo ? itemInfo : ''}</p>
                                            <p style="margin:0 0 14px 0;">
                                                ${showDisc ?
                                    `<span style=\"text-decoration: line-through; color: #888; font-size:1.18rem;\">原價: $${itemPrice}</span>
                                                     <span style=\"color: #d32f2f; font-weight: bold; margin-left: 12px; font-size:1.7rem;\">促銷價: $${discPrice}</span>`
                                    :
                                    `<span style=\"color:#1976d2;font-weight:700;font-size:1.7rem;\">$${itemPrice}</span>`
                                }
                                            </p>
                                            <form method="post" action="/item/add_to_shopCart" class="shopping-cart-form modal-cart-form"
                                                style="display: flex; align-items: center; gap: 10px; margin-top: 18px;">
                                                <input type="hidden" name="itemId" value="${itemId}">
                                                <input type="hidden" name="memId" value="${memId}">
                                                <input type="number" name="quantity" class="quantity-input" min="1" max="99" value="1"
                                                    style="width: 60px; height: 36px; border-radius: 6px; border: 1.5px solid #ccc; text-align: center; margin-right: 8px;font-size:1.1rem;" />
                                                <button type="button" class="add-to-cart-btn" style="font-size:1.1rem;height:40px;">加入購物車</button>
                                                <button type="button" class="add-to-favorite-btn ${favoriteClass}"
                                                    data-itemid="${itemId}" data-memid="${memId}" style="font-size:1.3rem;height:40px;width:40px;">
                                                    <i class="${starIcon}"></i>
                                                </button>
                                            </form>
                                        </div>
                                        <button class="modal-close" id="modal-close-btn" style="position:absolute;top:18px;right:24px;font-size:2.2rem;color:#888;cursor:pointer;background:none;border:none;">&times;</button>
                                    </div>
                                </div>
                            `;
                            $('#item-modal-backdrop').remove();
                            $('body').append(modalHtml);

                            // 關閉 modal
                            $('#modal-close-btn').on('click', function () {
                                $('#item-modal-backdrop').remove();
                            });
                            $('#item-modal-backdrop').on('click', function (e) {
                                if (e.target === this) $('#item-modal-backdrop').remove();
                            });
                        });

                        // 商品名稱即時搜尋功能
                        $('#itemSearchInput').on('input', function () {
                            var keyword = $(this).val().trim().toLowerCase();
                            $('.item-row').each(function () {
                                var name = $(this).data('itemname').toLowerCase();
                                if (!keyword || name.includes(keyword)) {
                                    $(this).show();
                                } else {
                                    $(this).hide();
                                }
                            });
                        });
                    });
                </script>
            </main>
        </div>
    </div>

    <button id="cart-fab" title="查看購物車">
        <span class="material-icons">shopping_cart</span>
    </button>
</body>

</html>